<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>KNN House Price Predictor</title>
  <style>
    html, body { margin:0; height:100%; font-family: Arial, sans-serif; }
    body { display: flex; }

    #map { flex: 0 0 70%; height: 100vh; }
    #sidebar { flex: 0 0 30%; height: 100vh; overflow:auto; padding:15px; box-shadow:-2px 0 5px rgba(0,0,0,0.1);}
    h2 { margin-top:0; }
    label, input { display:block; margin:10px 0; }
    table { border-collapse: collapse; width: 100%; margin-top:10px;}
    th, td { border: 1px solid #ccc; padding: 6px; font-size:14px;}
    th { background:#f5f5f5; }
    .truth { color:green; font-weight:bold; }

    #welcomeScreen {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center;
      z-index: 1000; flex-direction: column; color: white;
    }
    #welcomeBox {
      background: white; color:black; padding:20px 30px; border-radius:12px; text-align:center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    #searchInput {
      width:90%; padding:6px; margin-bottom:10px;
      border:1px solid #ccc; border-radius:6px; font-size:14px;
    }
  </style>
</head>
<body>
  <!-- Welcome Screen -->
  <div id="welcomeScreen">
    <div id="welcomeBox">
      <h2>Welcome to KNN Housing Price Predictor</h2>
      <p>Please enter your name to continue:</p>
      <input type="text" id="username" placeholder="Enter your name"/>
      <button onclick="enterApp()">Enter</button>
    </div>
  </div>

  <div id="map"></div>
  <div id="sidebar">
    <h2 id="appTitle">KNN House Price Predictor</h2>
    <input id="searchInput" type="text" placeholder="Search for a place..."/>
    <label for="k">Number of neighbors (K):</label>
    <input type="number" id="k" value="5" min="1" max="20"/>
    <p><b>Clicked/Search Location:</b> <span id="clicked">â€”</span></p>
    <p><b>Predicted Avg Price:</b> <span id="pred">â€”</span></p>
    <p><b>True Price (if known):</b> <span id="truth">â€”</span></p>
    <p><b>Neighbors Used:</b> <span id="neighborsMeta">â€”</span></p>
    <table id="nbrs">
      <thead><tr><th>#</th><th>State</th><th>Distance (km)</th><th>Price</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- JS code stays the same as your previous script -->
  <script>
    let map, infoWindow, autocomplete;
    let markers = [], activeArrows = [], truthMarkers = [];

    const stateData = [
      { state:"California", lat:36.116203, lng:-119.681564, price:700000 },
      { state:"Texas", lat:31.054487, lng:-97.563461, price:280000 },
      { state:"New York", lat:42.165726, lng:-74.948051, price:520000 },
      { state:"Florida", lat:27.766279, lng:-81.686783, price:300000 },
      { state:"Illinois", lat:40.349457, lng:-88.986137, price:280000 },
      { state:"Washington", lat:47.400902, lng:-121.490494, price:450000 },
      { state:"Massachusetts", lat:42.230171, lng:-71.530106, price:500000 },
      { state:"Colorado", lat:39.059811, lng:-105.311104, price:450000 },
      { state:"Georgia", lat:33.040619, lng:-83.643074, price:250000 },
      { state:"Michigan", lat:43.326618, lng:-84.536095, price:250000 }
    ];

    const trainData = stateData.slice(0,7);
    const valData   = stateData.slice(7);

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 39.8283, lng: -98.5795 }, zoom: 4,
      });
      infoWindow = new google.maps.InfoWindow();

      const input = document.getElementById("searchInput");
      autocomplete = new google.maps.places.Autocomplete(input);
      autocomplete.bindTo("bounds", map);

      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place.geometry || !place.geometry.location) return;
        const loc = place.geometry.location;
        map.setCenter(loc);
        map.setZoom(6);
        handleSelection(loc.lat(), loc.lng(), place.formatted_address);
      });

      valData.forEach(v => {
        const marker = new google.maps.Marker({
          position: { lat:v.lat, lng:v.lng }, map: map,
          title: `${v.state} - True Price: $${v.price}`,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 6, fillColor: "green", fillOpacity: 0.9,
            strokeWeight: 1, strokeColor: "white"
          }
        });
        truthMarkers.push(marker);
      });

      map.addListener("click", e => {
        handleSelection(e.latLng.lat(), e.latLng.lng(), "Clicked point");
      });
    }

    function handleSelection(lat, lng, label) {
      const k = parseInt(document.getElementById("k").value);
      const neighbors = getKNN(lat, lng, k);
      const avg = neighbors.reduce((a, b) => a + b.price, 0) / neighbors.length;
      let truth = null;
      valData.forEach(v => { if (distance({lat,lng}, v) < 80) truth = v; });
      showInfo(lat, lng, label, avg, neighbors, truth);
    }

    function distance(a, b) {
      const R = 6371;
      const dLat = (b.lat - a.lat) * Math.PI/180;
      const dLng = (b.lng - a.lng) * Math.PI/180;
      const x = Math.sin(dLat/2)**2 +
        Math.cos(a.lat*Math.PI/180) * Math.cos(b.lat*Math.PI/180) *
        Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(x));
    }

    function getKNN(lat, lng, k) {
      return trainData.map(s => ({ ...s, d: distance({lat,lng}, {lat:s.lat, lng:s.lng}) }))
        .sort((a,b)=>a.d-b.d).slice(0,k);
    }

    function showInfo(lat, lng, label, avg, neighbors, truth) {
      const currencyFmt = new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"});
      const content = `
        <div style="font-weight:600">${label || "Selected location"}</div>
        <div class="small muted">${lat.toFixed(5)}, ${lng.toFixed(5)}</div>
        <div style="margin-top:6px">Predicted Avg: <b>${currencyFmt.format(avg)}</b></div>
        ${truth ? `<div class="truth">True Price: ${currencyFmt.format(truth.price)}</div>` : ""}
      `;
      infoWindow.setContent(content);
      infoWindow.setPosition({ lat, lng });
      infoWindow.open(map);

      document.getElementById("clicked").textContent = `${label} (${lat.toFixed(5)}, ${lng.toFixed(5)})`;
      document.getElementById("pred").textContent = currencyFmt.format(avg);
      document.getElementById("neighborsMeta").textContent = `K=${document.getElementById("k").value}`;
      document.getElementById("truth").textContent = truth ? currencyFmt.format(truth.price) : "â€”";

      const tb = document.querySelector("#nbrs tbody");
      tb.innerHTML = "";
      neighbors.forEach((n, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i+1}</td><td>${n.state}</td><td>${n.d.toFixed(1)} km</td><td>${currencyFmt.format(n.price)}</td>`;
        tb.appendChild(tr);
      });

      activeArrows.forEach(a => a.setMap(null)); activeArrows = [];
      markers.forEach(m => m.setMap(null)); markers = [];

      neighbors.forEach(n => {
        const arrow = new google.maps.Polyline({
          path: [ { lat, lng }, { lat: n.lat, lng: n.lng } ],
          geodesic: true, strokeColor: "#FF0000", strokeOpacity: 0.8, strokeWeight: 2,
          icons: [{ icon: { path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW }, offset: "100%" }],
          map: map
        });
        activeArrows.push(arrow);

        const marker = new google.maps.Marker({
          position: { lat: n.lat, lng: n.lng }, map: map,
          title: `${n.state} - ${currencyFmt.format(n.price)}`,
          icon: { path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW, scale: 5, fillColor: "blue", fillOpacity: 0.9, strokeWeight: 1, strokeColor: "white" }
        });
        markers.push(marker);
      });
    }

    function enterApp() {
      const name = document.getElementById("username").value.trim();
      if (!name) { alert("Please enter your name!"); return; }
      document.getElementById("welcomeScreen").style.display = "none";
      document.getElementById("appTitle").innerText = `Welcome ${name}! ðŸŽ‰ Housing Price Predictor (KNN)`;
    }
  </script>

  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDe2DyAS3NS3ugTLm9m2EmSJLpbkL6Bgv4&libraries=places&callback=initMap">
  </script>
</body>
</html>
