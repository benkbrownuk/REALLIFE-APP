<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KNN House Price Predictor ‚Äî All U.S. States</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app { display: grid; grid-template-columns: 360px 1fr; height: 100%; }
    #panel { padding: 16px; border-right: 1px solid #e5e7eb; overflow: auto; }
    #map { width: 100%; height: 100%; }
    h1 { font-size: 18px; margin: 0 0 8px; }
    .muted { color: #6b7280; font-size: 12px; }
    label { display: block; font-weight: 600; margin-top: 12px; }
    input[type="number"], select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #d1d5db; border-radius: 6px; }
    .row { display: flex; gap: 8px; }
    .row > * { flex: 1; }
    .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-top: 12px; background: #fff; }
    .result { font-size: 22px; font-weight: 700; margin-top: 8px; }
    .small { font-size: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { text-align: left; padding: 6px 4px; border-bottom: 1px solid #f3f4f6; font-size: 13px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #d1d5db; font-size: 12px; }
    .btn { display: inline-block; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; background: #f9fafb; cursor: pointer; }
    .btn:active { transform: translateY(1px); }
    .footer { font-size: 11px; margin-top: 12px; color: #6b7280; }
    .ok { color: #065f46; }
    .warn { color: #92400e; }
    #stateCount { font-weight: 700; }
    .loading { opacity: 0.6; }
    #note { font-size: 12px; color: #374151; }
    /* mobile */
    @media (max-width: 900px) { #app { grid-template-columns: 1fr; grid-template-rows: 360px 1fr; } #panel { border-right: none; border-bottom: 1px solid #e5e7eb; } }
  </style>
</head>
<body>
  <div id="app">
    <div id="panel">
      <h1>üè† KNN House Price Predictor</h1>
      <div class="muted">Real map + real state medians (Feb 2025). Click the map or search a city.</div>

      <div class="card">
        <label for="search">Search city/place</label>
        <input id="search" type="text" placeholder="e.g., Austin, TX" />

        <div class="row">
          <div>
            <label for="k">K neighbors</label>
            <input id="k" type="number" min="1" max="20" value="5" />
          </div>
          <div>
            <label for="power">Distance power (p)</label>
            <input id="power" type="number" min="0" max="4" step="0.5" value="2" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="showStates">Show state markers</label>
            <button id="showStates" class="btn">Toggle</button>
          </div>
          <div>
            <label for="resetView">&nbsp;</label>
            <button id="resetView" class="btn">Reset view</button>
          </div>
        </div>

        <div id="status" class="small muted" style="margin-top:8px;">Loading state coordinates‚Ä¶</div>
      </div>

      <div class="card">
        <div>Clicked location:</div>
        <div id="clicked" class="small muted">‚Äî</div>
        <div style="margin-top:8px;">Predicted price (KNN):</div>
        <div id="pred" class="result">‚Äî</div>
        <div id="note" class="small">
          Model: KNN on <span id="stateCount">0</span> state capital points (features: latitude, longitude).  
          Target: median <b>single-family</b> sale price (per state). Weighted average with 1/d<sup>p</sup>.
        </div>
      </div>

      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between;">
          <div>Nearest neighbors</div>
          <div class="pill" id="neighborsMeta">K=5</div>
        </div>
        <table id="nbrs">
          <thead>
          <tr><th>#</th><th>State</th><th>Dist (km)</th><th>Median ($)</th><th>Weight</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="footer">
        Data sources:
        <ul>
          <li>State median single-family sale prices (Feb 2025) via Bankrate summarizing Redfin monthly data. Accessed Sept 3, 2025.</li>
          <li>State capital coordinates from public CSV (latitude/longitude).</li>
        </ul>
        <div class="muted small">KNN is a simple baseline; local sub-state variation can be large. For comps, use city/ZIP microdata.</div>
      </div>
    </div>
    <div id="map"></div>
  </div>

  <script>
    // ---------- Median single-family sale prices by state (Bankrate/Redfin, Feb 2025) ----------
    // Source/citation in page footer; values copied from Bankrate's "Median home prices in every state" (accessed 2025-09-03).
    // Includes DC. Keys are full state names.
    const STATE_MEDIANS = {
      "Alabama": 282400, "Alaska": 400500, "Arizona": 470200, "Arkansas": 255300, "California": 866100,
      "Colorado": 640000, "Connecticut": 466000, "Delaware": 396100, "District of Columbia": 920000,
      "Florida": 433600, "Georgia": 374700, "Hawaii": 975500, "Idaho": 474700, "Illinois": 285600,
      "Indiana": 258900, "Iowa": 230600, "Kansas": 280900, "Kentucky": 270200, "Louisiana": 253200,
      "Maine": 375800, "Maryland": 496500, "Massachusetts": 749900, "Michigan": 249300, "Minnesota": 370900,
      "Mississippi": 255100, "Missouri": 263300, "Montana": 528000, "Nebraska": 288800, "Nevada": 496000,
      "New Hampshire": 502300, "New Jersey": 526500, "New Mexico": 370600, "New York": 576100,
      "North Carolina": 380300, "North Dakota": 350000, "Ohio": 248600, "Oklahoma": 245900, "Oregon": 521500,
      "Pennsylvania": 301000, "Rhode Island": 484800, "South Carolina": 403600, "South Dakota": 325700,
      "Tennessee": 389100, "Texas": 339500, "Utah": 588500, "Vermont": 388000, "Virginia": 457500,
      "Washington": 658700, "West Virginia": 258800, "Wisconsin": 318000, "Wyoming": 450000
    };

    // ---------- Load state capital coordinates (lat/lng) from a public CSV ----------
    // Raw CSV columns: Capital,State,Abbreviation,Latitude,Longitude,Population
    // Source: https://raw.githubusercontent.com/jasperdebie/VisInfo/master/us-state-capitals.csv
    const CAPITALS_CSV_URL = "https://raw.githubusercontent.com/jasperdebie/VisInfo/master/us-state-capitals.csv";

    const statePoints = [];      // {state, capital, lat, lng, median}
    let map, autocomplete, infoWindow;
    let stateMarkersVisible = false;
    const stateMarkers = [];
    const currencyFmt = new Intl.NumberFormat("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 0 });

    function setStatus(msg, good=false) {
      const el = document.getElementById("status");
      el.textContent = msg;
      el.className = "small " + (good ? "ok" : "muted");
    }

    async function loadCapitals() {
      setStatus("Loading state coordinates‚Ä¶");
      try {
        const res = await fetch(CAPITALS_CSV_URL, { cache: "force-cache" });
        const text = await res.text();
        const rows = text.trim().split(/\r?\n/);
        const header = rows.shift().split(",").map(s => s.replaceAll('"','').trim());
        const idx = {
          Capital: header.findIndex(h => h.match(/Capital/i)),
          State: header.findIndex(h => h.match(/^State$/i)),
          Latitude: header.findIndex(h => h.match(/Latitude/i)),
          Longitude: header.findIndex(h => h.match(/Longitude/i))
        };
        rows.forEach((line) => {
          const parts = parseCSVLine(line);
          const state = parts[idx.State].replaceAll('"','').trim();
          const capital = parts[idx.Capital].replaceAll('"','').trim();
          const lat = parseFloat(parts[idx.Latitude]);
          const lng = parseFloat(parts[idx.Longitude]);
          const median = STATE_MEDIANS[state];
          if (!isNaN(lat) && !isNaN(lng) && median) {
            statePoints.push({ state, capital, lat, lng, median });
          }
        });

        // Add DC manually (it's not always present in the CSV)
        if (!statePoints.find(s => s.state === "District of Columbia")) {
          statePoints.push({ state: "District of Columbia", capital: "Washington", lat: 38.9072, lng: -77.0369, median: STATE_MEDIANS["District of Columbia"] });
        }

        document.getElementById("stateCount").textContent = statePoints.length;
        setStatus(`Loaded ${statePoints.length} states. Click the map or search a place.`, true);
        drawStateMarkers();
      } catch (e) {
        console.error(e);
        setStatus("Failed to load capital coordinates. Check your internet connection.", false);
      }
    }

    // Minimal CSV parser for simple, quoted lines
    function parseCSVLine(line) {
      const out = [];
      let cur = "", inQ = false;
      for (let i=0;i<line.length;i++) {
        const c = line[i];
        if (c === '"' ) {
          if (inQ && line[i+1] === '"') { cur += '"'; i++; }
          else { inQ = !inQ; }
        } else if (c === ',' && !inQ) {
          out.push(cur); cur = "";
        } else {
          cur += c;
        }
      }
      out.push(cur);
      return out;
    }

    // Haversine distance in kilometers
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2-lat1) * Math.PI/180;
      const dLon = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    // KNN regression on points [{lat,lng,median}]
    function predictPrice(lat, lng, k=5, power=2) {
      const withDist = statePoints.map(pt => {
        const d = Math.max(1e-6, haversine(lat, lng, pt.lat, pt.lng)); // avoid div-by-zero
        return { ...pt, d };
      }).sort((a,b)=>a.d-b.d);

      const neighbors = withDist.slice(0, Math.min(k, withDist.length));
      let wsum = 0, ysum = 0;
      neighbors.forEach(n => {
        // inverse distance weighting: w = 1 / d^p  (p>=0; p=0 means simple mean)
        const w = power > 0 ? 1 / (n.d ** power) : 1;
        wsum += w;
        ysum += w * n.median;
      });
      const yhat = ysum / (wsum || 1);
      return { yhat, neighbors };
    }

    function neighborsTable(neighbors, power) {
      const tb = document.querySelector("#nbrs tbody");
      tb.innerHTML = "";
      neighbors.forEach((n, i) => {
        const w = power > 0 ? 1 / (n.d ** power) : 1;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${n.state} <span class="muted small">(${n.capital})</span></td>
          <td>${n.d.toFixed(0)}</td>
          <td>${currencyFmt.format(n.median)}</td>
          <td>${w.toExponential(2)}</td>
        `;
        tb.appendChild(tr);
      });
    }

    function drawStateMarkers() {
      // clear existing
      stateMarkers.forEach(m => m.setMap(null));
      stateMarkers.length = 0;

      statePoints.forEach(pt => {
        const m = new google.maps.Marker({
          position: { lat: pt.lat, lng: pt.lng },
          title: `${pt.capital}, ${pt.state}\nMedian: ${currencyFmt.format(pt.median)}`,
          map: stateMarkersVisible ? map : null
        });
        m.addListener("click", () => {
          const { yhat, neighbors } = predictPrice(pt.lat, pt.lng, Number(kInput.value), Number(powerInput.value));
          showInfo(pt.lat, pt.lng, `${pt.capital}, ${pt.state}`, yhat, neighbors);
        });
        stateMarkers.push(m);
      });
    }

    function toggleStateMarkers() {
      stateMarkersVisible = !stateMarkersVisible;
      stateMarkers.forEach(m => m.setMap(stateMarkersVisible ? map : null));
    }

    function showInfo(lat, lng, label, yhat, neighbors) {
      const content = `
        <div style="font-weight:600">${label || "Selected location"}</div>
        <div class="small muted">${lat.toFixed(5)}, ${lng.toFixed(5)}</div>
        <div style="margin-top:6px">Predicted: <b>${currencyFmt.format(yhat)}</b></div>
      `;
      infoWindow.setContent(content);
      infoWindow.setPosition({ lat, lng });
      infoWindow.open(map);
      document.getElementById("clicked").textContent = `${label || "‚Äî"}  (${lat.toFixed(5)}, ${lng.toFixed(5)})`;
      document.getElementById("pred").textContent = currencyFmt.format(yhat);
      document.getElementById("neighborsMeta").textContent = `K=${kInput.value}`;
      neighborsTable(neighbors, Number(powerInput.value));
    }

    function resetView() {
      map.panTo({ lat: 39.5, lng: -98.35 });
      map.setZoom(4);
    }

    // ---------- Google Maps setup ----------
    let kInput, powerInput;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 39.5, lng: -98.35 }, // U.S. centroid-ish
        zoom: 4,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false
      });
      infoWindow = new google.maps.InfoWindow();

      // Place Autocomplete
      const input = document.getElementById("search");
      autocomplete = new google.maps.places.Autocomplete(input, {
        fields: ["geometry", "name", "formatted_address"],
        types: ["(cities)"]
      });
      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (place && place.geometry && place.geometry.location) {
          const loc = place.geometry.location;
          map.panTo(loc);
          map.setZoom(11);
          runPredictionAt(loc.lat(), loc.lng(), `${place.name || ""} ‚Äî ${place.formatted_address || ""}`);
        }
      });

      // Click to predict
      map.addListener("click", (e) => {
        runPredictionAt(e.latLng.lat(), e.latLng.lng(), "User-selected point");
      });

      kInput = document.getElementById("k");
      powerInput = document.getElementById("power");
      kInput.addEventListener("change", () => { if (lastClick) runPredictionAt(lastClick.lat, lastClick.lng, lastClick.label); });
      powerInput.addEventListener("change", () => { if (lastClick) runPredictionAt(lastClick.lat, lastClick.lng, lastClick.label); });

      document.getElementById("showStates").addEventListener("click", () => {
        toggleStateMarkers();
        drawStateMarkers();
      });
      document.getElementById("resetView").addEventListener("click", resetView);

      loadCapitals().then(() => {
        // After capitals load, do an initial demo prediction (Kansas)
        const demo = { lat: 39.11, lng: -94.63, label: "Demo ‚Äî Kansas City area" };
        runPredictionAt(demo.lat, demo.lng, demo.label);
      });
    }

    let lastClick = null;
    function runPredictionAt(lat, lng, label) {
      lastClick = { lat, lng, label };
      const k = Math.max(1, Math.min(20, Number(kInput.value) || 5));
      const power = Math.max(0, Math.min(4, Number(powerInput.value) || 2));
      const { yhat, neighbors } = predictPrice(lat, lng, k, power);
      showInfo(lat, lng, label, yhat, neighbors);
    }

    // Expose initMap globally for Google callback
    window.initMap = initMap;
  </script>

  <!-- Google Maps JavaScript API (with Places library). Restrict this key in Google Cloud! -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDe2DyAS3NS3ugTLm9m2EmSJLpbkL6Bgv4&libraries=places&callback=initMap">
  </script>
</body>
</html>
